name: Build and Release

on:
  push:
    tags:
    - 'v*' # Triggers on tags starting with 'v', e.g., v1.0.1
  workflow_dispatch:


jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup MSVC Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Configure CMake
      run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

    - name: Build Project
      run: cmake --build build

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Run Concurrency Tests
      shell: pwsh
      run: |
        # Start the server and FORCE it to run inside the build directory
        $server = Start-Process -FilePath "httpdLite.exe" `
                  -WorkingDirectory "build" `
                  -PassThru `
                  -WindowStyle Hidden

        try {
            Write-Host "Running functional test..."
            python test_html.py
            
            Write-Host "Running concurrency stress test..."
            python test_concurrency.py
            
            Write-Host "Running methods stress test..."
            python test_methods.py
            
            Write-Host "Running resources stress test..."
            python test_resources.py
        }
        finally {
            # This block runs even if one of the python commands above fails
            Write-Host "Stopping server..."
            Stop-Process -Id $server.Id -Force
        }

    - name: Package Release Files
      shell: pwsh
      run: |
        # 1. Create a clean staging folder
        New-Item -ItemType Directory -Path "release_pkg/build"

        # 2. Copy the executable into the build directory
        Copy-Item "build/httpdLite.exe" -Destination "release_pkg/build/"

        # 3. Copy the html directory INSIDE the build directory (where the server expects it)
        Copy-Item -Path "html" -Destination "release_pkg/build/" -Recurse

        # 4. Copy Test/Runner files to the root (so they are next to the build folder)
        $files = "test_html.py", "test_concurrency.py", "test_methods.py", "test_resources.py", "run_tests.bat", "CMakeLists.txt"
        foreach ($file in $files) {
            if (Test-Path $file) { Copy-Item $file -Destination "release_pkg/" }
        }

        # 6. Compress the contents of release_pkg
        Compress-Archive -Path "release_pkg/*" -DestinationPath "httpdLite_${{ github.ref_name }}.zip"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          *.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
